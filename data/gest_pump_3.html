<!DOCTYPE html>
<html>
<head>
  <title>Controleur Pompe Engrais</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" type="text/css" href="style.css">
  
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="raphael-2.1.4.min.js"></script>
  <!--<script src="../justgage-1.0.1.js"></script>-->
  <script src="justgage.js"></script>
  <script>
	
	function toogle_status(element,num_pump) {
		var xhr = new XMLHttpRequest();
		if(element.checked){
	xhr.open("GET", "/post?pump="+num_pump+"&state=1", true); }
		else { xhr.open("GET", "/post?pump="+num_pump+"&state=0", true); }
  xhr.send();
}
	
	$(document).ready(function(){
		if(!%STATUS_PUMP3%)
		{
			$('form input[id="name_pump"]').prop("disabled", true);
			$('form input[id="submit_pump"]').prop("disabled", true);
			$('form input[id="type_prog_jour"]').attr("disabled", true);
			$('form input[id="type_prog_hebdo"]').attr("disabled", true);
			$('form input[id="dose_value"]').attr("disabled", true);
			$('form input[id="bottle_capacity"]').prop("disabled", true);
			$('form input[id="type_prog_hebdo"]').prop("checked", false);
			$('form input[id="type_prog_jour"]').prop("checked", false);
			$( "#daily" ).hide();
			$( "#weekly" ).hide();
			$('.remaining_day').hide();
		}
		else
		{
			$('form input[id="name_pump"]').prop("disabled", false);
			$('form input[id="submit_pump"]').prop("disabled", false);
			$('form input[id="type_prog_jour"]').attr("disabled", false);
			$('form input[id="type_prog_hebdo"]').attr("disabled", false);
			$('form input[id="dose_value"]').attr("disabled", false);
			$('form input[id="bottle_capacity"]').prop("disabled", false);
			$(".toogle_active").prop("checked", true);
			
			if ("%PER_DAY2%" == "jour")
			{
				$('form input[id="type_prog_jour"]').prop("checked", true);
				$( "#daily" ).show();
				$('.remaining_day').show();
				var day=Math.floor((%BOTTLE_CAPACITY3%-%DELIVERY3%)/%DOSE3%);
				$('.remaining_day').html(day + 'j');
			}
			else
			{
				$('form input[id="type_prog_hebdo"]').prop("checked", true);
				$('select[name="daylist"]').find('option[value="%WEEKLY_DAY_3%"]').attr("selected",true);
				$( "#weekly" ).show();
				$('.remaining_day').show();
				var day=Math.floor((%BOTTLE_CAPACITY3%-%DELIVERY3%)/%DOSE3%*7);
				$('.remaining_day').html(day + 'j');
			}
			

		}
        $(".toogle_active").click(function(){
            if($(this).prop("checked") == true){
                $('form input[id="name_pump"]').prop("disabled", false);
				$('form input[id="submit_pump"]').prop("disabled", false);
				$('form input[id="type_prog_jour"]').attr("disabled", false);
				$('form input[id="type_prog_hebdo"]').attr("disabled", false);
				$('form input[id="dose_value"]').attr("disabled", false);
				$('form input[id="bottle_capacity"]').prop("disabled", false);
				$('#slider-range').attr("disabled", false);
				$('#slider-time-hebdo').attr("disabled", false);
				if ("%PER_DAY2%" == "jour")
				{
					$('form input[id="type_prog_jour"]').prop("checked", true);
					$( "#daily" ).show();
					$('.remaining_day').show();
					var day=Math.floor((%BOTTLE_CAPACITY3%-%DELIVERY3%)/%DOSE3%);
					$('.remaining_day').html(day + 'j');
				}
				else
				{
					$('form input[id="type_prog_hebdo"]').prop("checked", true);
					$('select[name="daylist"]').find('option[value="%WEEKLY_DAY_3%"]').attr("selected",true);
					$( "#weekly" ).show();
					$('.remaining_day').show();
					var day=Math.floor((%BOTTLE_CAPACITY3%-%DELIVERY3%)/%DOSE3%*7);
					$('.remaining_day').html(day + 'j');
				}
            }
            else if($(this).prop("checked") == false){
                $('form input[id="name_pump"]').prop("disabled", true);
				$('form input[id="submit_pump"]').prop("disabled", true);
				$('form input[id="type_prog_jour"]').attr("disabled", true);
				$('form input[id="type_prog_hebdo"]').attr("disabled", true);
				$('form input[id="dose_value"]').attr("disabled", true);
				$('form input[id="bottle_capacity"]').prop("disabled", true);
				$('#slider-range').attr("disabled", true);
				$('#slider-time-hebdo').attr("disabled", true);
				$('form input[id="type_prog_hebdo"]').prop("checked", false);
				$('form input[id="type_prog_jour"]').prop("checked", false);
				$( "#daily" ).hide();
				$( "#weekly" ).hide();
				$('.remaining_day').hide();
            }
        });
		
	/*	$(".toogle_active").click(function(){
            if($(this).prop("checked") == true){
                $('form input[id="name_pump1"]').prop("disabled", false);
				$('form input[id="submit_pump1"]').prop("disabled", false);
				$('form input[id="type_prog_jour"]').attr("disabled", false);
				$('form input[id="type_prog_hebdo"]').attr("disabled", false);
				$('form input[id="dose_value"]').attr("disabled", false);
				$('form input[id="bottle_capacity1]').attr("disabled", false);
				$('#slider-range').attr("disabled", false);
				$('#slider-time-hebdo').attr("disabled", false);
			}
            else if($(this).prop("checked") == false){
                $('form input[id="name_pump1"]').prop("disabled", true);
				$('form input[id="submit_pump1"]').prop("disabled", true);
				$('form input[id="type_prog_jour"]').attr("disabled", true);
				$('form input[id="type_prog_hebdo"]').attr("disabled", true);
				$('form input[id="dose_value"]').attr("disabled", true);
				$('form input[id="bottle_capacity1]').attr("disabled", true);
				$('#slider-range').attr("disabled", true);
				$('#slider-time-hebdo').attr("disabled", true);
            }
        });*/
		
		$("input[name='type_prog']").click(function(event){
			if ($(this).val() === 'jour') {
				$( "#daily" ).show();
				$( "#weekly" ).hide();
			} else {
				$( "#daily" ).hide();
				$( "#weekly" ).show();
			}
		});
		
			if ($("input[name='dose_day']").val() > 1)
			{
				$( "#slider-daily").show();
				$( "#slider-uniq-daily").hide();
			}
			else{
				$( "#slider-daily").hide();
				$( "#slider-uniq-daily").show();
			}
		
		 $("input[name='dose_day']").on('change', function() {
			if ($("input[name='dose_day']").val() > 1)
			{
				$( "#slider-daily").show();
				$( "#slider-uniq-daily").hide();
			}
			else{
				$( "#slider-daily").hide();
				$( "#slider-uniq-daily").show();
			}
		 });
		
	});
	
	
	
	function submitPump() {
	console.log('avant la save');
    alert("Parametre de la pompe sauvegardÃ©");
    setTimeout(function(){ document.location.reload(false); }, 500);
	console.log('apres la save');
  }
  
  	function submitReset() {
    alert("Les parametres de la pompes vont etre reinitialises!");
    setTimeout(function(){ document.location.reload(false); }, 500);
	}
	
	function submitRefill() {
    alert("Volume disponible reinitialise!");
    setTimeout(function(){ document.location.reload(false); }, 500);
	}
	
  document.addEventListener("DOMContentLoaded", function (event) {
   var liquid1 = new JustGage({
        id: "liquid1",
        //value: getRandomInt(0, 100),
		value: 100-(%DELIVERY3%*100/%BOTTLE_CAPACITY3%),
        min: 0,
        max: 100,
        title: "Engrais restant:",
        label: "",
        startAnimationTime: 2000,
        startAnimationType: ">",
        refreshAnimationTime: 1000,
        refreshAnimationType: "bounce",
		levelColors: [
          "#FF0000",
          "#FFFF00",
          "#00FF00"
		],
		textRenderer: function (val) {
          return (val + "");
        }
      });
	 
	setInterval(function () {
		liquid1.refresh(100-(%DELIVERY3%*100/%BOTTLE_CAPACITY3%));
    }, 2500); 
	 
  });
  
  	function submitMessageCalibration() {
		alert("La calibration de la pompe commencera dans 10s");
	}
	
	function submitCalib() {
    alert("Valeur de calibration sauvegarde");
    setTimeout(function(){ document.location.reload(false); }, 500);
  }
 
  </script>
  
  <script>
	$(function() {
		if ("%PER_DAY3%" == "jour")
		{
			if("%DOSE_DAY3%" > 1)
			{
				
			}
			else if ("%DOSE_DAY3%" == 1)
			{
				
			}
		}
		
		
		$("#slider-range").slider({
		range: true,
		min: 0,
		max: 1440,
		step: 15,
		values: [540, 1020],
		slide: function (e, ui) {
			var hours1 = Math.floor(ui.values[0] / 60);
			var minutes1 = ui.values[0] - (hours1 * 60);

			if (hours1.length == 1) hours1 = '0' + hours1;
			if (minutes1.length == 1) minutes1 = '0' + minutes1;
			if (minutes1 == 0) minutes1 = '00';
			if (hours1 >= 12) {
				if (hours1 == 12) {
					hours1 = hours1;
					minutes1 = minutes1;
				} else {
					//hours1 = hours1 - 12;
					minutes1 = minutes1;
				}
			} else {
				hours1 = hours1;
				minutes1 = minutes1;
			}
			

			$('.slider-time').html(hours1 + ':' + minutes1);

			var hours2 = Math.floor(ui.values[1] / 60);
			var minutes2 = ui.values[1] - (hours2 * 60);

			if (hours2.length == 1) hours2 = '0' + hours2;
			if (minutes2.length == 1) minutes2 = '0' + minutes2;
			if (minutes2 == 0) minutes2 = '00';
			if (hours2 >= 12) {
				if (hours2 == 12) {
					hours2 = hours2;
					minutes2 = minutes2;
				} else if (hours2 == 24) {
					hours2 = 23;
					minutes2 = "59 ";
				} else {
				   // hours2 = hours2 - 12;
					minutes2 = minutes2;
				}
			} else {
				hours2 = hours2;
				minutes2 = minutes2;
			}

			$('.slider-time2').html(hours2 + ':' + minutes2);
		}
		});
	});
  </script>
  
  <script>
	$(function() {
	
		strWeekly_hour="%PROG_HOUR_3%";
		strWeekly_min="%PROG_MIN_3%";
		intValWeekly=parseInt(strWeekly_hour*60)+parseInt(strWeekly_min);
		
		$("#slider-time-hebdo").slider({
		min: 0,
		max: 1440,
		step: 15,
		values: [intValWeekly],
		slide: function (e, ui) {
			var hours1 = Math.floor(ui.values[0] / 60);
			var minutes1 = ui.values[0] - (hours1 * 60);

			if (hours1.length == 1) hours1 = '0' + hours1;
			if (minutes1.length == 1) minutes1 = '0' + minutes1;
			if (minutes1 == 0) minutes1 = '00';
			if (hours1 >= 12) {
				if (hours1 == 12) {
					hours1 = hours1;
					minutes1 = minutes1;
				} else {
					//hours1 = hours1 - 12;
					minutes1 = minutes1;
				}
			} else {
				hours1 = hours1;
				minutes1 = minutes1;
			}
			if (hours1 == 24) {
					hours1 = 23;
					minutes1 = "59 ";
				}

			$('.slider-time1-hebdo').html(hours1 + ':' + minutes1);
			$('#prog-hour').val(hours1);
			$('#prog-min').val(minutes1);
		}
		});
	});
  </script>
  
  <script>
	$(function() {
	
		strDaily_hour="%PROG_HOUR_3%";
		strDaily_min="%PROG_MIN_3%";
		intValDaily=parseInt(strDaily_hour*60)+parseInt(strDaily_min);
		
		$("#slider-time-daily").slider({
		min: 0,
		max: 1440,
		step: 15,
		values: [intValDaily],
		slide: function (e, ui) {
			var hours1 = Math.floor(ui.values[0] / 60);
			var minutes1 = ui.values[0] - (hours1 * 60);

			if (hours1.length == 1) hours1 = '0' + hours1;
			if (minutes1.length == 1) minutes1 = '0' + minutes1;
			if (minutes1 == 0) minutes1 = '00';
			if (hours1 >= 12) {
				if (hours1 == 12) {
					hours1 = hours1;
					minutes1 = minutes1;
				} else {
					//hours1 = hours1 - 12;
					minutes1 = minutes1;
				}
			} else {
				hours1 = hours1;
				minutes1 = minutes1;
			}
			if (hours1 == 24) {
					hours1 = 23;
					minutes1 = "59 ";
				}

			$('.slider-time1-daily').html(hours1 + ':' + minutes1);
			$('#prog-hour').val(hours1);
			$('#prog-min').val(minutes1);
		}
		});
	});
  </script>
  
  
</head>

<body>
  <h1>Calibration Pompe</h1>
  
  <nav class=menu>
	<ul>
		<li><a href="/">Accueil</a></li>
		<li><a href="#">Gestion Pompes</a>
			<ul id="submenu">
				<li><a href="/gest_pump_1.html">Pompe 1</a></li>
				<li><a href="/gest_pump_2.html">Pompe 2</a></li>
				<li><a href="/gest_pump_3.html">Pompe 3</a></li>
			</ul>
		</li>
		<li><a href="/status.html">Status</a></li>
		<li><a href="/calib.html">Calibration</a></li>
	</ul>
  </nav>
  <br>
  <br>

  <p>
	Gestion de la pompe 3
		<br>
		<p>
	Pompe 2: (Calibration actuelle: %calibPump_3% mL)
		<br>
		<a href="/calib_pump?pump=3" onclick="submitMessageCalibration()"><button class="calib">Calibrer Pompe 3</button></a>
		<form action="/post" target="hidden-form">
			<input type="text" name="pump" value="3" hidden>
			Valeur de la calibration en mL: <input type="number" name="calib_pump" step="0.01">
		<input type="submit" value="Enregistrer" onclick="submitCalib()">
</form>
<iframe style="display:none" name="hidden-form"></iframe>
<br>
  </p>
		<div>
			Activer Pompe:<label class="switch">
				<input type="checkbox" class="toogle_active" onchange="toogle_status(this,3)">
			<span class="slider round"></span>
			</label><br/><br/>
			<form action="/post" target="hidden-form" name="settings_pump">
				<input type="text" name="pump" value="3" hidden>
				Nom de la pompe: <input type="text" name="name_pump" id="name_pump" value="%NAME_PUMP3%"> <br/><br/>
				Dosage:   <input type="radio" id="type_prog_jour" name="type_prog" value="jour">
						<label for="jour">Journalier</label>
							<input type="radio" id="type_prog_hebdo" name="type_prog" value="hebdo" >
							<label for="hebdo">Hebdomadaire</label>
				<br/>
				<div id="weekly">
					<label for="daylist">Jour de la semaine:</label>
					<select id="daylist" name="daylist">
						<option value="dowMonday">Lundi</option>
						<option value="dowTuesday">Mardi</option>
						<option value="dowWednesday">Mercredi</option>
						<option value="dowThursday">Jeudi</option>
						<option value="dowFriday">Vendredi</option>
						<option value="dowSaturday">Samedi</option>
						<option value="dowSunday">Dimanche</option>
					</select><br/><br/>
					<div class="slider-time-hebdo">
						<label for="slider-time-hebdo">Horaire de distribution:</label><span class="slider-time1-hebdo">%PROG_HOUR_3%:%PROG_MIN_3%</span><br/><br/>
						<div id="slider-time-hebdo"></div>
					</div>
				</div>
				<div id="daily">
					<label for="dose_day">Nombre de dose par jour:</label> <input type="number" name="dose_day" class="dose_day" step="1" min="1" value="%DOSE_DAY3%" ><br/><br/>
					<div id="slider-daily">
						<label for="slider-range">Plage horaire:</label><span class="slider-time">08:30 </span> - <span class="slider-time2">18:00</span><br/><br/>
						<div id="slider-range"></div>
					</div>	
					<div id="slider-uniq-daily">
						<label for="slider-time-daily">Horaire de distribution:</label><span class="slider-time1-daily">%PROG_HOUR_3%:%PROG_MIN_3% </span><br/><br/>
						<div id="slider-time-daily"></div>
					</div>
				</div>
				<input type="text" id="prog-hour" name="prog-hour" value="%PROG_HOUR_3%" hidden>
				<input type="text" id="prog-min" name="prog-min" value="%PROG_MIN_3%" hidden>
				<label for="dose_value">Dose (en mL):</label><input type="float" step="0.1" id="dose_value" name="dose_value" value="%DOSE3%"><br/>
				<label for="bottle_capacity">Volume bouteille (en mL):</label><input type="number" id="bottle_capacity" name="bottle_capacity" value="%BOTTLE_CAPACITY3%"><br/>
				<input type="submit" id="submit_pump" value="Enregistrer" onclick="submitPump()" >
			
			</form>
			<div id="liquid1">
			<label>Duree d'utilisation restante (sur la base de la programmation actuelle) :</label><span class="remaining_day"></span></div>
			
			<iframe style="display:none" name="hidden-form"></iframe>
			<form action="/reset" target="hidden-form" name="reset_pump">
				<input type="text" id="pump" name="pump" value="3" hidden>
				<input type="submit" id="reset_pump" value="Reinitialiser les parametres" onclick="submitReset()" >
			</form>
			<iframe style="display:none" name="hidden-form"></iframe>
			<form action="/refill" target="hidden-form" name="refill_pump">
				<input type="text" id="pump" name="pump" value="2" hidden>
				<input type="submit" id="refill_pump" value="Changement de bouteille" onclick="submitRefill()" >
			</form>
			
		</div>
<br>
  </p>
  
  </body>
</html>